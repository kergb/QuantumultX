
function y(n={}){let e=Object.create(null),t=r=>typeof r=="string"?r.toLowerCase():r;for(let[r,o]of Object.entries(n))e[t(r)]=o;let s={get(r,o){return Reflect.get(r,t(o))},set(r,o,i){return Reflect.set(r,t(o),i)},has(r,o){return Reflect.has(r,t(o))},deleteProperty(r,o){return Reflect.deleteProperty(r,t(o))},ownKeys(r){return Reflect.ownKeys(r)},getOwnPropertyDescriptor(r,o){return Reflect.getOwnPropertyDescriptor(r,t(o))},defineProperty(r,o,i){return Reflect.defineProperty(r,t(o),i)}};return new Proxy(e,s)}function b(n){return typeof n!="object"||n===null?String(n):typeof n.toString=="function"&&n.toString!==Object.prototype.toString?Array.isArray(n)?JSON.stringify(n):n.toString():n instanceof RegExp?n.toString():n instanceof Date?n.toISOString():JSON.stringify(n)}var p=class n{static getInstance(e){let t="Surge";if(typeof $loon<"u")t="Loon";else if(typeof $task<"u")throw new Error("QuantumultX is not supported");return n.instances[t]||(n.instances[t]=n.classNames[t](e,t)),n.instances[t]}static classNames={Surge:(e,t)=>new l(e,t),Loon:(e,t)=>new h(e,t)};static instances={};className;name;logLevels={debug:1,info:2,warn:3,error:4,off:5};logLevel=this.logLevels.error;request;response;argument;_url;get url(){return this._url||(this._url=new URL(this.request.url)),this._url}constructor(e,t){this.className=t??"",this.name=e??"",this.init()}createProxy(e){return new Proxy(e,{get:this.getFn,set:this.setFn})}getFn(e,t,s){return Reflect.get(e,t,s)}setFn(e,t,s,r){return Reflect.set(e,t,s,r),!0}getJSON(e){let t=this.getVal(e);return t?JSON.parse(t):null}setJSON(e,t){this.setVal(JSON.stringify(e),t)}logWithPrefix(e,t){console.log(`${e}${t.map(s=>b(s)).join(" | ")}`)}log(...e){this.logWithPrefix("",e)}debug(...e){this.logLevel>this.logLevels.debug||this.logWithPrefix("[DEBUG]",e)}info(...e){this.logLevel>this.logLevels.info||this.logWithPrefix("[INFO]",e)}warn(...e){this.logLevel>this.logLevels.warn||this.logWithPrefix("[WARN]",e)}error(...e){this.logLevel>this.logLevels.error||this.logWithPrefix("[ERROR]",e)}exit(){$done({})}abort(){$done()}},l=class n extends p{static propertyMap={bodyBytes:"body"};getFn(e,t,s){let r=n.propertyMap[t]||t;return super.getFn(e,r,s)}setFn(e,t,s,r){let o=n.propertyMap[t]||t;return super.setFn(e,o,s,r)}init(){typeof $request=="object"&&(this.request=this.createProxy($request)),typeof $response=="object"&&(this.response=this.createProxy($response)),typeof $argument=="string"&&(this.argument=JSON.parse($argument),"logLevel"in this.argument&&(this.logLevel=this.logLevels[this.argument.logLevel]??this.logLevels.error))}getVal(e){return $persistentStore.read(e)}setVal(e,t){return $persistentStore.write(e,t)}fetch(e){let{method:t,body:s,timeout:r=5,...o}=e;return new Promise((i,d)=>{$httpClient[t]({...o,body:s,"binary-mode":s instanceof Uint8Array,timeout:r},(a,u,f)=>{if(a)return d(a);let S=f instanceof Uint8Array?"bodyBytes":"body";i({status:u.status,headers:u.headers,[S]:f})})})}notify(e=this.name,t="",s="",r={}){let{openUrl:o,clipboard:i,mediaUrl:d,dismiss:a,sound:u=!0}=r,f={url:o,text:i,"media-url":d,"auto-dismiss":a,sound:u};o?f.action="open-url":i&&(f.action="clipboard"),$notification.post(e,t,s,f)}ungzip(e){return $utils.ungzip(e)}done(e){$done(e)}abort(){$done({abort:!0})}},h=class extends l{init(){super.init(),typeof $argument=="object"&&(this.argument=$argument,"logLevel"in this.argument&&(this.logLevel=this.logLevels[this.argument.logLevel]??this.logLevels.error))}fetch(e){return e.timeout=(e.timeout??5)*1e3,super.fetch(e)}notify(e=this.name,t="",s="",r={}){let{openUrl:o,mediaUrl:i,clipboard:d,delay:a}=r,u={openUrl:o,mediaUrl:i,clipboard:d};$notification.post(e,t,s,u,a)}abort(){$done()}};var g=class{message;domParser=new DOMParser;constructor(e){this.message=this.fromString(e)}fromString(e){return this.domParser.parseFromString(e,"text/html")}toString(){return this.message.documentElement.outerHTML}query(e){return Array.from(this.message.querySelectorAll(e))}append(e,...t){return t.map(s=>e.appendChild(s))}remove(e){return e.map(t=>t.parentElement?.removeChild(t))}};var c=p.getInstance("missav"),m=class extends g{scriptElementFilter=e=>{let t=e.innerText||"";return!!(e.getAttribute("src")?.includes("tsyndicate.com")||t.includes("TSOutstreamVideo")||t.includes("htmlAds"))};constructor(e){if(!y(c.response.headers)["content-type"]?.includes("text/html"))throw new Error("Invalid URL");super(e)}done(){this.process(),c.done({body:this.toString()})}process(){this.removeElement(),this.addElement()}removeElement(){this.remove(this.query("script").filter(this.scriptElementFilter))}addElement(){let e=this.message.createElement("script");e.textContent="(function(){\"use strict\";document.addEventListener(\"ready\",()=>{if(window.open=()=>{},window.player?.pause){let e=window.player.pause;window.player.pause=()=>{document.hasFocus()&&e()}}})})();\n";let t=this.message.createElement("style");t.textContent=".lg\\:block,.lg\\:hidden,a[href*=\"//bit.ly/\"],div[x-init*=\"#genki-counter'\"],div:has(a[href*=\"go.myavlive.com\"]),[x-show$=\"video_details'\"]>div>ul,div[style*=\"width: 300px; height: 250px;\"],.relative>div[x-init*=\"campaignId=under_player\"],div[x-show^=recommendItems]~div[class]:has(>div>div.mx-auto>div.flex>a[rel^=sponsored]){display:none!important}\n",this.append(this.message.head,e,t)}};try{new m(c.response.body).done()}catch(n){c.error(n,c.request.url)}finally{c.exit()}



//禁missav跳转其他窗口，禁失焦播放，去除广告
let body = $response.body;
const injectedScript = `
<script>
(function () {
  'use strict';

  // ==== 1. 广告清除：立即执行 + MutationObserver ====
  const adSelectors = [
    "a[href^='https://theporndude.com']",
    "a[href*='mycomic']",
    "a[href*='myavlive']",
    "[href*='bit.ly']",
    "[href*='bit.ly'][target=_blank]",
    "a[href*='/vip']",
    "iframe",
    "#a[href*='//bit.ly/']",
    "div[style*='z-index: 1001']",
    "ul.space-y-2.mb-4.ml-4.list-disc.text-nord14",
    "div.space-y-5.mb-5",
    "div.under_player",
    "div[style='width: 300px; height: 250px;']"
  ];

  const cleanAds = () => {
    adSelectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(el => el.remove());
    });
  };
 cleanAds(); // 首次执行
  new MutationObserver(cleanAds).observe(document.documentElement, { childList: true, subtree: true });
 // ✅ 注入脚本中用于防止跳转
try {
  Object.defineProperty(window, 'open', {
    value: () => {},
    writable: false,
    configurable: true
  });
} catch (e) {
  window.open = () => {};
}

  // ==== 3. 防失焦播放：延迟执行（方案一） ====
  const preventPause = () => {
    try {
      Object.defineProperty(document, 'hidden', { get: () => false, configurable: true });
      Object.defineProperty(document, 'visibilityState', { get: () => 'visible', configurable: true });
    } catch (e) {}

    ['visibilitychange', 'webkitvisibilitychange', 'blur', 'focus'].forEach(event => {
      window.addEventListener(event, e => e.stopImmediatePropagation(), true);
      document.addEventListener(event, e => e.stopImmediatePropagation(), true);
    });

    setInterval(() => {
      document.dispatchEvent(new Event('visibilitychange'));
      document.dispatchEvent(new Event('webkitvisibilitychange'));
    }, 1500);
  };

  setTimeout(preventPause, 3000); // 延迟执行防暂停
})();
</script>
`;

body = body.replace(/<head>/i, `<head>${injectedScript}`);

$done({ body });